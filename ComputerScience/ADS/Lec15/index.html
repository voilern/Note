<!DOCTYPE html><html lang="zh" class="no-js"><head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="voilern's Notebook">
      
      
        <meta name="author" content="voilern">
      
      
        <link rel="canonical" href="https://voilern.github.io/Note/ComputerScience/ADS/Lec15/">
      
      
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.12">
    
    
      
        <title>Lecture 15 | External Sorting - voilern's Notebook</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.2afb09e1.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/css/card.css">
    
      <link rel="stylesheet" href="../../../stylesheets/css/flink.css">
    
      <link rel="stylesheet" href="../../../stylesheets/css/extra.css">
    
      <link rel="stylesheet" href="https://unpkg.com/katex@0/dist/katex.min.css">
    
      <link rel="stylesheet" href="https://static.zeoseven.com/zsft/292/main/result.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"><script src="../../../assets/javascripts/glightbox.min.js"></script><style id="glightbox-style">
            html.glightbox-open { overflow: initial; height: 100%; }
            .gslide-title { margin-top: 0px; user-select: text; }
            .gslide-desc { color: #666; user-select: text; }
            .gslide-image img { background: white; }
            .gscrollbar-fixer { padding-right: 15px; }
            .gdesc-inner { font-size: 0.75rem; }
            body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color); }
            body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color); }
            body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color); }
        </style></head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lecture-15-external-sorting" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="voilern's Notebook" class="md-header__button md-logo" aria-label="voilern's Notebook" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"></path></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            voilern's Notebook
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lecture 15 | External Sorting
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo" aria-label="Switch to dark mode" type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"></path></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo" aria-label="Switch to light mode" type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"></path></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"></path></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"></path></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/voilern/Note/" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
  </div>
  <div class="md-source__repository">
    voilern/Note
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../FDS/" class="md-tabs__link">
          
  
  
    
  
  Computer Science

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../Research/checkmate/" class="md-tabs__link">
          
  
  
    
  
  Research

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="voilern's Notebook" class="md-nav__button md-logo" aria-label="voilern's Notebook" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"></path></svg>

    </a>
    voilern's Notebook
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/voilern/Note/" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"></path></svg>
  </div>
  <div class="md-source__repository">
    voilern/Note
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2">
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Computer Science
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Computer Science
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
      
        
          
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../FDS/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    数据结构基础
    
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            数据结构基础
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    高级数据结构与算法分析
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            高级数据结构与算法分析
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Lec01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lecture 1: AVL Trees &amp; Splay Trees
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Lec02/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lecture 2: Red Black Tree &amp; B+ Tree
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Lec03/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lecture 3: Inverted File Index
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Lec04/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lecture 4: Leftist Heap &amp; Skew Heap
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Lec05/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lecture 5: Binomial Queue
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lec06_v/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lecture 6: Backtraking
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Ex01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Topic 1: Amortized Analysis
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../homework/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Homework
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../discussion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Discussion
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../quiz/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Quiz
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../CO/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    计算机组成
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            计算机组成
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CO/ch01/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ch 1: 计算机概要与技术
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../OOP/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    面向对象程序设计
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            面向对象程序设计
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../OOP/lec2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lecture 2: Using Objects
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../OOP/lec3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lecture 3: Class
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../OOP/lec4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lecture 4: Object Interaction
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../CS106L/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    CS106L
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            CS106L
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CS106L/lec1/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lecture 1: Welcome to CS106L
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CS106L/lec2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lecture 2: Types &amp; Structs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CS106L/lec3/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lecture 3: Initialization &amp; References
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CS106L/lec4/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Lecture 4: Streams
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6">
        
          
          <div class="md-nav__link md-nav__container">
            <a href="../../Others/" class="md-nav__link ">
              
  
  
  <span class="md-ellipsis">
    Others
    
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            Others
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Others/wsl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    WSL
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3">
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Research
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Research
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../Research/checkmate/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Checkmate: Breaking the Memory Wall with Optimal Tensor Rematerialization
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      概述
    </span>
  </a>
  
    <nav class="md-nav" aria-label="概述">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      逻辑维度
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      物理维度
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      具体分析
    </span>
  </a>
  
    <nav class="md-nav" aria-label="具体分析">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      朴素过程分析
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      优化空间
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pass" class="md-nav__link">
    <span class="md-ellipsis">
      pass 数量分析与优化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="pass 数量分析与优化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    <span class="md-ellipsis">
      替换选择算法
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tape" class="md-nav__link">
    <span class="md-ellipsis">
      tape 数量分析与优化
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#k" class="md-nav__link">
    <span class="md-ellipsis">
      k 路内排序优化
    </span>
  </a>
  
    <nav class="md-nav" aria-label="k 路内排序优化">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    <span class="md-ellipsis">
      霍夫曼树优化
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    <span class="md-ellipsis">
      并行优化
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="lecture-15-external-sorting">Lecture 15 | External Sorting<a class="headerlink" href="#lecture-15-external-sorting" title="Permanent link">¶</a></h1>
<div style="margin-top: -30px; font-size: 0.75em; opacity: 0.7;">
<p><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12a10 10 0 0 0 10 10 10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8 8 8 0 0 1-8-8 8 8 0 0 1 8-8zm6.78 1a.7.7 0 0 0-.48.2l-1.22 1.21 2.5 2.5L20.8 5.7c.26-.26.26-.7 0-.95L19.25 3.2c-.13-.13-.3-.2-.47-.2m-2.41 2.12L9 12.5V15h2.5l7.37-7.38z"></path></svg></span> 约 6424 个字 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 17H7V3h14m0-2H7a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2M3 5H1v16a2 2 0 0 0 2 2h16v-2H3m12.96-10.71-2.75 3.54-1.96-2.36L8.5 15h11z"></path></svg></span> 5 张图片 <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 20c4.42 0 8-3.58 8-8s-3.58-8-8-8-8 3.58-8 8 3.58 8 8 8m0-18c5.5 0 10 4.5 10 10s-4.5 10-10 10C6.47 22 2 17.5 2 12S6.5 2 12 2m.5 11H11V7h1.5v4.26l3.7-2.13.75 1.3z"></path></svg></span> 预计阅读时间 21 分钟</p>
</div>
<div class="admonition quote">
<p class="admonition-title">link</p>
<p>Wikipedia: https://en.wikipedia.org/wiki/External_sorting</p>
</div>
<p>外排序与数据库系统中的相关内容有交叉关系，当需要排序的数据过大，而无法被完全放在内存时，普通的排序算法无法被应用。此时需要使用外排序，简单来说就是在更大的尺度上进行类似归并的操作。</p>
<p>而正因为此，外部排序的过程与硬件设计有一定关系。</p>
<details class="section" open="open">
<summary>与硬件相关的一些说明</summary>
<p>具体来说，普通的排序算法排序的对象都是放在内存里的一些数据，例如一个 <code>int</code> 数组。然而外部排序排序的对象，或者说要排序的那个“数组”，没法被完整地存在内存里，它们都被存储在硬盘之类的非易失介质中，而从这种介质里读取数据往往具有较大的开销，所以我们总是“一块一块”从里面那数据。</p>
<blockquote>
<p>打个比方，你现在需要对一整个图书馆（硬盘）的书做排序，但是你的桌子（内存）上最多放下三十本书，换句话来说，你一次最多处理三十本书。而为了从图书馆中获取需要排的书，你得先找到这些书在哪（seek），然后再把连续的三十本书拿出来（block transfer），放到你的桌子（内存）上再排序，而为了给接下来三十本书腾位置，你还得把排好的三十本书再放回去（即记录下排序结果，同样也是一次 block transfer）。</p>
</blockquote>
<p>综上所述，外部排序主要解决的就是，按照怎样的策略来对这些数据进行排序。</p>
</details>
<div class="admonition info">
<p class="admonition-title">导读</p>
<p>由于 ADS 介绍的外排序和同时期数据库系统这门课介绍的外排序有同有异，所以我打算先在大概讲外排序的核心思路，再展开 ADS 课程中的具体过程。</p>
</div>
<hr>
<h2 id="_1">概述<a class="headerlink" href="#_1" title="Permanent link">¶</a></h2>
<p>外排序的基本思路就是将数据分为若干个小块，然后对每个小块进行排序，最后再将这些小块合并起来。而我们常说的归并排序，指的是递归地将两块合成一块，而所谓的 <span class="arithmatex">\(k\)</span> <strong>路（<span class="arithmatex">\(k\)</span>-way）</strong>归并，就是将 <span class="arithmatex">\(k\)</span> 块合成一块。</p>
<p>那么如何归并呢？我将从两个维度来简单阐述。</p>
<hr>
<h3 id="_2">逻辑维度<a class="headerlink" href="#_2" title="Permanent link">¶</a></h3>
<p>外部排序所使用的归并排序从逻辑上来讲和普通的归并排序一致，总是将 <span class="arithmatex">\(k\)</span> 个有序序列合并为 1 个有序序列。</p>
<p>而这里的“有序序列”，在外排序中被称为“run”，即每次归并我们另 <span class="arithmatex">\(k\)</span> 个 run 变成一个 run。正着说就是：</p>
<div class="admonition definition">
<p class="admonition-title">run</p>
<p>一个 run 指的是一段过程中的数据，在本文中特指待归并的有序的序列，在 <span class="arithmatex">\(k\)</span>-way merge 中，我们总是将 <span class="arithmatex">\(k\)</span> 个 run 合并为 1 个 run。</p>
<div class="admonition warning">
<p class="admonition-title">说明</p>
<p>这里的 run 的定义是我自己脑补出来的，并不确定是否严格，但是可以保证的是： 一个 run 在参与 merge 之前肯定已经有序了，可以理解为 "have already run"，而为了不搅糊读者的脑子，我这里就以这个定义为准。</p>
</div>
</div>
<p>从执行的顺序来说，<strong>内</strong>排序中的归并排序是一个自上而下不断 <span class="arithmatex">\(\frac{1}{k}\)</span> 地划分，再自下而上不断归并的过程。相反，<strong>外</strong>排序由于其特性限制，其“归并段”并不是自上而下 <span class="arithmatex">\(\frac{1}{k}\)</span> 划分出来的，而是根据硬件处理能力，直接划分好最小的归并段，然后直接自下而上归并。</p>
<p>而这样一个将 <span class="arithmatex">\(k \cdot c\)</span> 个 run merge 成 <span class="arithmatex">\(c\)</span> 个 run 的过程，我们称之为一个 <code>pass</code>。（在归并树上体现为一层。）</p>
<hr>
<h3 id="_3">物理维度<a class="headerlink" href="#_3" title="Permanent link">¶</a></h3>
<blockquote>
<p>关于物理维度，涉及到一些硬件知识，在 ADS 中为了方便说明会将其简化，有关 block 的概念将被抽象化为“数据单位”。</p>
</blockquote>
<p>我们知道，内存的大小是有限的，划分给归并数据的内存也应当是有限的，我们用 <span class="arithmatex">\(M\)</span> 来记它，即内存中一次只能处理 <span class="arithmatex">\(M\)</span> 个单位的数据。</p>
<blockquote>
<p>更细节的，我们应当更具物理大小来计算 <span class="arithmatex">\(M\)</span>，例如一条数据的大小是 <span class="arithmatex">\(l \text{Bytes}\)</span>，而内存的大小是 <span class="arithmatex">\(m \text{Bytes}\)</span>，那么一个内存能够容纳的数据数量应当为 <span class="arithmatex">\(\lfloor \frac{m}{l} \rfloor\)</span>。</p>
</blockquote>
<p>但是既然要归并，我们就需要将 <span class="arithmatex">\(k\)</span> 路的数据读入到内存中，最理想的情况下我们肯定希望这 <span class="arithmatex">\(k\)</span> 路都能读入到内存中，但是显然这是不切实际的，我们最多公平地读入每一路的前 <span class="arithmatex">\(\lfloor \frac{M}{k} \rfloor\)</span> 个数据——但这已经足够——对于 <span class="arithmatex">\(k\)</span> 个有序序列的合并操作，其合并过程中也恰好只与最靠前的、未排序的一部分数据有关。</p>
<div class="admonition warning">
<p class="admonition-title">说明</p>
<p>之后所提到的，有关于排序数据的“内存”，指的都是划分给算法，用来存放归并数据的内存！</p>
</div>
<div class="admonition eg">
<p class="admonition-title">example</p>
<p>举例来说，假设现在有两个 run，分别为：</p>
<ol>
<li><code>1</code> <code>3</code> <code>5</code> <code>7</code> <code>9</code></li>
<li><code>0</code> <code>2</code> <code>4</code> <code>6</code> <code>8</code></li>
</ol>
<p>但是内存只能放 4 个单位数据，所以对于每个 run 总是只有前 2 个数据是可见的。但是这并不影响我们可以确定这两个 run 合并的结果中，前一部分是 <code>0</code> <code>1</code> <code>2</code>，而至于 <code>2</code> 后面排什么，则要从 <code>run2</code> 中取出之后的数据，再与 <code>run1</code> 余下的 <code>_</code> <code>3</code> 合并。</p>
<div class="admonition key-point">
<p class="admonition-title">易错点</p>
<p>注意，当其中一个段的 buffer 空了以后，我们不能直接把其他段的 buffer 直接排序进去，而必须先填充这个空 buffer 的内容，再继续排序。</p>
<p>想象这样一个情况，空 buffer 将要载入的下一段数据是 <code>3</code> <code>4</code> <code>5</code>，而另外一个 buffer 剩下的数据是 <code>7</code>，那么显然，<code>3</code> <code>4</code> <code>5</code> 应该先于 <code>7</code> 被排序。</p>
</div>
</div>
<p>而这个过程也正是外排序能够进行的一个重要基础。</p>
<hr>
<p>其中比较特别的步骤就是，最开始的排序，即第一个 pass。先前我们在<a href="#逻辑维度" target="_blank">#逻辑维度</a>里提到了，外排序的第一个 pass 会直接划分好最小的归并段，而这个“最小归并段”的大小就是 <span class="arithmatex">\(M\)</span>。用语言描述，就是最早的 run 的大小就是平均每一路能够在内存中处理的最大数据单位量。</p>
<p>然而问题出现了，根据我之前给出的定义，run 应当是有序的，但是从原始数据里读出来的“最小归并段”是无序的。但是对于最初的 run，它必然能够整段放到内存里（更进一步的，也只有最初的 run 能够完整地放到内存里），因此直接对其进行内排序即可。</p>
<div class="admonition advice">
<p class="admonition-title">逻辑联系</p>
<ul>
<li>因为内排序很快，所以要尽可能利用内排序；</li>
<li>所以一开始就要将能内排序做的事情都用内排序解决；</li>
<li>所以最初的 run 的大小是 <span class="arithmatex">\(M\)</span>。</li>
</ul>
</div>
<hr>
<div class="admonition info">
<p class="admonition-title">中继</p>
<p>以上内容是对外排序核心思想的一个简单介绍，接下来我们将以 ADS 所介绍的外排序范式，来介绍一下具体的过程和一些改进。</p>
</div>
<hr>
<h2 id="_4">具体分析<a class="headerlink" href="#_4" title="Permanent link">¶</a></h2>
<p>ADS 中相比上面介绍的部分，又引入了一个叫 tape 的概念，tape 的中文是磁带，而在这个框架中，我更倾向于把它当作一个抽象的概念。</p>
<p>相对应的，其实际过程与上面描述的方法可能有一些感受上的差别，如果只是了解思想的话上半部分已经足够（当然后面还有一些基于如下模型的优化讨论），但是毕竟还是面向考试，所以还是需要以 ADS 课件的方法再介绍一次。</p>
<div class="admonition warning">
<p class="admonition-title">说明</p>
<p>我之后会以 run 为单位，来描述合并过程。但是实际发生在计算机里的步骤更加复杂：</p>
<p>需要先将每一条 tape 的一部分数据读入内存的 buffer 中，然后利用这些 buffer 来进行排序；当某个 buffer 空了以后要立刻将对应 tape 的下一部分数据读入，直到没有数据可以填充为止。</p>
<p>也正是<a href="#物理维度">#物理维度</a>所说的那些。</p>
</div>
<hr>
<h3 id="_5">朴素过程分析<a class="headerlink" href="#_5" title="Permanent link">¶</a></h3>
<p>我们以 2-way merge 为例，结合 ADS 课件中的配图来说明。</p>
<details class="section" open="open">
<summary>准备</summary>
<p></p><center>
<a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../img/66.png" data-desc-position="bottom"><img alt="" src="../img/66.png"></a>
</center><p></p>
<p>图中 <span class="arithmatex">\(T_1\)</span> 是一条 tape 的编号，我们可以理解为一个序列的物理地址，或更通俗的来说，可以当作一个数组，只不过它的实际数据是在硬盘中。换句话来说，这里的 tape 表示的都是硬盘中的数据。</p>
<p>这条 tape 中有 13 个元素，我们记其为 <span class="arithmatex">\(N = 13\)</span>。而这条原始的 tape 被划分为了 5 段，每一段都有不超过 3 个元素，此时 <span class="arithmatex">\(M = 3\)</span>。即有 <span class="arithmatex">\(\lceil \frac{N}{M} \rceil = 5\)</span>。</p>
</details>
<details class="section" open="open">
<summary>Pass 1</summary>
<p>现在我们要开始 merge 了。对于这段数据来说，这是意义重大的“人生第一次”，相比于其他归并都是从 2 个 tape 开始的 pass，这一次显得有些特殊。</p>
<p>在第一轮中，面对全部都是无序的数据，我们将这 <span class="arithmatex">\(\lceil \frac{N}{M} \rceil = 5\)</span> 个段均分到两条 tape 上（2-way），这里经历两个步骤：</p>
<ol>
<li>依次读取 <span class="arithmatex">\(T_1\)</span> 中每一段数据（刚好占满内存），并对它们进行内排序；</li>
<li>将排序完的段，追加写到 <span class="arithmatex">\(T_2\)</span> 或 <span class="arithmatex">\(T_3\)</span> 中（具体每一个 tape 写几条，会有专门策略做调整，目前先平分着放）；</li>
</ol>
<p>于是，<span class="arithmatex">\(T_1\)</span> 中的数据便被转移到了 <span class="arithmatex">\(T_2\)</span> 和 <span class="arithmatex">\(T_3\)</span>。为了重复利用 tape，此时的 <span class="arithmatex">\(T_1\)</span> 被看作可以用的空磁盘了。</p>
<p></p><center>
<a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../img/67.png" data-desc-position="bottom"><img alt="" src="../img/67.png"></a>
</center><p></p>
<p>于是，完成了第一个 pass。</p>
</details>
<details class="section" open="open">
<summary>Pass 2</summary>
<p>之后的 pass 则基本遵循同样的规则，不断取每一路的第一个 run 并 merge，并且将结果写到两个（k 个）闲置的 tape 上（和前面说过的一样，这里暂且将分配策略定为平分到每一个 tape 上）。</p>
<p>例如，我们要取 <span class="arithmatex">\(T_2\)</span> 和 <span class="arithmatex">\(T_3\)</span> 的第一段，执行归并操作，得到一个新的，有 6 个数据的 run，并写到闲置的 <span class="arithmatex">\(T_1\)</span> 上；接下来取 <span class="arithmatex">\(T_2\)</span> 和 <span class="arithmatex">\(T_3\)</span> 的第二段，归并得到新的 run，此时我们发现，<span class="arithmatex">\(T_1\)</span>、<span class="arithmatex">\(T_2\)</span>、<span class="arithmatex">\(T_3\)</span> 都不是闲置的，所以我们需要一个新的 tape，写到 <span class="arithmatex">\(T_4\)</span> 上。</p>
<p></p><center>
<a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../img/68.png" data-desc-position="bottom"><img alt="" src="../img/68.png"></a>
</center><p></p>
<p>于是，完成了第二个 pass。</p>
</details>
<details class="section" open="open">
<summary>Pass 3</summary>
<p>pass 3 和 pass 2 的过程基本一致。现在的 tape 状态是 <span class="arithmatex">\(\{T_2, T_3\}\)</span> 闲置，我们取 <span class="arithmatex">\(T_1\)</span> 和 <span class="arithmatex">\(T_4\)</span> 的第一段，得到一个新的 run，包含 12 个元素；取 <span class="arithmatex">\(T_1\)</span> 和 <span class="arithmatex">\(T_4\)</span> 的第二段，得到一个新的 run，包含 1 个元素。这两段被分配到两条空闲 tape 上，即 <span class="arithmatex">\(T_2\)</span> 和 <span class="arithmatex">\(T_3\)</span>。</p>
<p></p><center>
<a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../img/69.png" data-desc-position="bottom"><img alt="" src="../img/69.png"></a>
</center><p></p>
<p>于是，完成了第三个 pass。</p>
</details>
<details class="section" open="open">
<summary>Pass 4</summary>
<p>同样，pass 4 和前面两个 pass 的过程也是一致性的，不做过多解释，对于规模更大的数据也是一样，除了第一个 pass 比较特殊，其它 pass 都是一样的。最终得到只剩下一个 tape 中包含唯一的 run 时，排序就结束了。</p>
<p></p><center>
<a class="glightbox" data-type="image" data-width="auto" data-height="auto" href="../img/70.png" data-desc-position="bottom"><img alt="" src="../img/70.png"></a>
</center><p></p>
<p>至此，排序结束。</p>
</details>
<hr>
<h3 id="_6">优化空间<a class="headerlink" href="#_6" title="Permanent link">¶</a></h3>
<p>可以优化的部分主要有这么几个：</p>
<ul>
<li>一个 pass 意味着若干次 seek，所以减少 pass 可以是一个方向；<ul>
<li><a href="#pass-数量分析与优化" target="_blank">#pass-数量分析与优化</a></li>
</ul>
</li>
<li>merge 的过程中会多次读取 tape 中的数据，而对于计算机来说单次大量读取比多次小量读取更高效，如何优化数据读取也是一个方向；<ul>
<li><a href="#tape-数量分析与优化" target="_blank">#tape-数量分析与优化</a></li>
</ul>
</li>
<li>如何更高效的在 <span class="arithmatex">\(k\)</span>-way merge 过程中，归并 M 个分别来自 k 个序列的数据，即内排序的策略，也上优化的一个方向；<ul>
<li><a href="#k-路内排序优化" target="_blank">#k-路内排序优化</a></li>
</ul>
</li>
<li>读入、内排序、输出，这三个事务目前是停机串行的，考虑将其并行化也是一个方向；<ul class="task-list">
<li class="task-list-item"><label class="task-list-control"><input type="checkbox" disabled><span class="task-list-indicator"></span></label> TODO</li>
</ul>
</li>
</ul>
<hr>
<h3 id="pass">pass 数量分析与优化<a class="headerlink" href="#pass" title="Permanent link">¶</a></h3>
<p>例子中一共经过了 4 次 pass。如果我们记 <span class="arithmatex">\(max(\#run)\)</span> 为 <span class="arithmatex">\(\#run\)</span> 最多的 tape 的 <span class="arithmatex">\(\#run\)</span>，则每一次 pass 会令 <span class="arithmatex">\(max(\#run)\)</span> 缩小一半，直到 <span class="arithmatex">\(max(\#run)\)</span> 变为 1，且只有它一条 tape 还有数据，标志着排序结束。</p>
<p>如果专注于 <span class="arithmatex">\(\#run\)</span> 的变化，那么上面的模拟步骤大致是这么一个过程：</p>
<div class="admonition section">
<p class="admonition-title">Pass 1</p>
<p>原先 <span class="arithmatex">\(T_1\)</span> 上 <span class="arithmatex">\(\#run = 5\)</span>，现将它分配到两条 tape 上，于是有：</p>
<ul>
<li><span class="arithmatex">\(T_2\)</span> 上 <span class="arithmatex">\(\#run = 3\)</span>；</li>
<li><span class="arithmatex">\(T_3\)</span> 上 <span class="arithmatex">\(\#run = 2\)</span>；</li>
</ul>
</div>
<div class="admonition section">
<p class="admonition-title">Pass 2</p>
<p>依次取 <span class="arithmatex">\(T_2\)</span> 和 <span class="arithmatex">\(T_3\)</span> 的第一段，归并得到新的 run，均分到另外两条 tape 上（未优化的做法，优化做法参考<a href="#tape-数量分析与优化" target="_blank">#tape-优化</a>），于是有：</p>
<ul>
<li><span class="arithmatex">\(T_2\)</span> 上 <span class="arithmatex">\(\#run = 3-1 = 2\)</span>；</li>
<li><span class="arithmatex">\(T_3\)</span> 上 <span class="arithmatex">\(\#run = 2-1 = 1\)</span>；</li>
<li><span class="arithmatex">\(T_1\)</span> 上 <span class="arithmatex">\(\#run = 0+1 = 1\)</span>；</li>
<li><span class="arithmatex">\(T_4\)</span> 上 <span class="arithmatex">\(\#run = 0\)</span>；</li>
</ul>
<p>继续取，即：</p>
<ul>
<li><span class="arithmatex">\(T_2\)</span> 上 <span class="arithmatex">\(\#run = 2-1 = 1\)</span>；</li>
<li><span class="arithmatex">\(T_3\)</span> 上 <span class="arithmatex">\(\#run = 1-1 = 0\)</span>；</li>
<li><span class="arithmatex">\(T_1\)</span> 上 <span class="arithmatex">\(\#run = 1\)</span>；</li>
<li><span class="arithmatex">\(T_4\)</span> 上 <span class="arithmatex">\(\#run = 0+1 = 1\)</span>；</li>
</ul>
<p><span class="arithmatex">\(T_3\)</span> 上已经没有了，但是 <span class="arithmatex">\(T_2\)</span> 还没取完，所以只从 <span class="arithmatex">\(T_2\)</span> 拿：</p>
<ul>
<li><span class="arithmatex">\(T_2\)</span> 上 <span class="arithmatex">\(\#run = 1-1 = 0\)</span>；</li>
<li><span class="arithmatex">\(T_3\)</span> 上 <span class="arithmatex">\(\#run = 0\)</span>；</li>
<li><span class="arithmatex">\(T_1\)</span> 上 <span class="arithmatex">\(\#run = 1+1 = 2\)</span>；</li>
<li><span class="arithmatex">\(T_4\)</span> 上 <span class="arithmatex">\(\#run = 1\)</span>；</li>
</ul>
</div>
<p>模拟到从这里其实已经可以看出来了，对于 2-way merge 来说，排除末段情况，从第二个 pass 开始，基本上每次都是从 2 路中各取 1 个 run，并合并为 1 个 run。换句话来说，每一个 pass 会让 <span class="arithmatex">\(total(\#run)\)</span> 缩小为原来的 <span class="arithmatex">\(\frac{1}{2}\)</span>。</p>
<p>那么，对于 <span class="arithmatex">\(k\)</span>-way merge 来说，就是从第二个 pass 开始，每次从 <span class="arithmatex">\(k\)</span> 路中各取 1 个 run，并合并为 1 个 run，每一个 pass 会让 <span class="arithmatex">\(total(\#run)\)</span> 缩小为原来的 <span class="arithmatex">\(\frac{1}{k}\)</span>。</p>
<p>因此，我们可以归纳得到如下计算式：</p>
<div class="arithmatex">\[
\begin{aligned}
\#pass &amp;= \underbrace{
        1
    }_{\text{pass 1}}
    + 
    \underbrace{
        \lceil \log_{k}{(\#run)}\rceil
    }_{\text{rest passes}} \\
    &amp;= \underbrace{
        1
    }_{\text{pass 1}}
    + 
    \underbrace{
        \lceil \log_{k}{
            \lceil \frac{N}{M} \rceil
        }\rceil
    }_{\text{rest passes}} 
\end{aligned}
\]</div>
<p>其中，<span class="arithmatex">\(k\)</span> 表示归并路数，<span class="arithmatex">\(N\)</span> 表示数据量，<span class="arithmatex">\(M\)</span> 表示内存一次能处理的数据量。</p>
<p>那么，减少 pass 的方法也很直观了，只需要增加 <span class="arithmatex">\(k\)</span> 即可，即采取更多路的归并，就能减少 pass。</p>
<p>然而，其中必然存在一个 trade-off 的关系，虽然 <span class="arithmatex">\(k\)</span> 增加可以减少 <span class="arithmatex">\(\#pass\)</span>，但是在接下来一节中我们会知道，<span class="arithmatex">\(k\)</span> 过大会导致 tape 需求量增加，此外，<span class="arithmatex">\(k\)</span> 的增加也会导致内排序的复杂度增加，也会增加 pass 内的 seek 次数。</p>
<p>当然，除了暴力的增加 <span class="arithmatex">\(k\)</span> 以外，我们还可以通过使用<strong>替换选择(Replacement Selection)</strong>算法，来生成比 <span class="arithmatex">\(M\)</span> 大的初始 run，以相对减少 pass 数量。</p>
<h4 id="_7">替换选择算法<a class="headerlink" href="#_7" title="Permanent link">¶</a></h4>
<p><strong>替换选择(Replacement Selection)</strong> 在 hw15 中被布置为编程题，所以其实现过程可以结合那道题目来学习。</p>
<details class="section">
<summary>Replacement Selection @ PTA</summary>
<p>When the input is much too large to fit into memory, we have to do external sorting instead of internal sorting. One of the key steps in external sorting is to generate sets of sorted records (also called runs) with limited internal memory. The simplest method is to read as many records as possible into the memory, and sort them internally, then write the resulting run back to some tape. The size of each run is the same as the capacity of the internal memory.</p>
<p><strong>Replacement Selection</strong> sorting algorithm was described in 1965 by Donald Knuth. Notice that as soon as the first record is written to an output tape, the memory it used becomes available for another record. Assume that we are sorting in ascending order, if the next record is not smaller than the record we have just output, then it can be included in the run.</p>
<p>For example, suppose that we have a set of input { 81, 94, 11, 96, 12, 99, 35 }, and our memory can sort 3 records only. By the simplest method we will obtain three runs: { 11, 81, 94 }, { 12, 96, 99 } and { 35 }. According to the replacement selection algorithm, we would read and sort the first 3 records { 81, 94, 11 } and output 11 as the smallest one. Then one space is available so 96 is read in and will join the first run since it is larger than 11. Now we have { 81, 94, 96 }. After 81 is out, 12 comes in but it must belong to the next run since it is smaller than 81. Hence we have { 94, 96, 12 } where 12 will stay since it belongs to the next run. When 94 is out and 99 is in, since 99 is larger than 94, it must belong to the <strong>first run</strong>. Eventually we will obtain two runs: the first one contains { 11, 81, 94, 96, 99 } and the second one contains { 12, 35 }.</p>
<p>Your job is to implement this replacement selection algorithm.</p>
</details>
<p>利用替换选择策略以后，每一次生成的 run 一定不小于 <span class="arithmatex">\(M\)</span>（末端余数除外），于是相对来说 <span class="arithmatex">\(\#pass\)</span> 就会减少。</p>
<hr>
<h3 id="tape">tape 数量分析与优化<a class="headerlink" href="#tape" title="Permanent link">¶</a></h3>
<p>如果使用<a href="#朴素过程分析" target="_blank">#朴素过程分析</a>中的方法，那么我们使用 <span class="arithmatex">\(k\)</span>-way merge 至少需要 <span class="arithmatex">\(2k\)</span> 个 tape。</p>
<p>这其实很好理解，我们每一个 pass 需要 <span class="arithmatex">\(k\)</span> 个 tape 来存放每一路的序列，而其结果要平分放复制到下一个 pass 所需要的 <span class="arithmatex">\(k\)</span> 个 pass 中，所以至少需要 <span class="arithmatex">\(2k\)</span> 个 tape 轮换着来存储数据。</p>
<p>而这不利于我们通过增加 <span class="arithmatex">\(k\)</span> 来减少 <span class="arithmatex">\(\#pass\)</span>，因此我们考虑某种策略来优化 tape 的使用。</p>
<p>在<a href="#朴素过程分析" target="_blank">#朴素过程分析</a>中我多次暗示，之后会对「将归并后的 run 平分到各 tape」这件事做优化。</p>
<p>我们可以考虑，不平均的将归并后的 run 分配到各个 tape 上，即总有一些 tape 比别的 tape 多一些 run。虽然在平分的策略中，也有可能会有多出来的 run，但是只会多一个（也就是将 <span class="arithmatex">\(x \mod k\)</span> 的余数分配到其中几个 tape 上）。此时这些多出来的 run 可能就是单纯的从一个 tape 别复制到另外一个 tape 上，看起来是个非常没必要的操作，为什么不直接留下它，将当前 tape 拿到下一轮用呢？</p>
<p>但是由于平分策略下，这个情况的出现并不可控，而且总是会引起悬殊的 tape 间的数量差，所以我们考虑能不能主动利用这个性质。</p>
<p><del>实在想不到怎么过度了，而且急急急，所以直接上结论。</del></p>
<p>我们按照 Fibonacci 数列的项来分配每个 tape 的 <span class="arithmatex">\(\#run\)</span>，此时每一个 pass 只需要一个有一个空闲的 tape 即可。</p>
<div class="admonition eg">
<p class="admonition-title">example</p>
<div class="arithmatex">\[
\text{Fibonacci}: {1,1,2,3,5,8,13,21,...}
\]</div>
<p>假设我们现在有两个 tape，分别有 23 个 run 和 13 个 run，则：</p>
<table>
<thead>
<tr>
<th style="text-align: center;"><span class="arithmatex">\(T_1\)</span></th>
<th style="text-align: center;"><span class="arithmatex">\(T_2\)</span></th>
<th style="text-align: center;"><span class="arithmatex">\(T_3\)</span></th>
<th style="text-align: left;">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: center;">21</td>
<td style="text-align: center;">13</td>
<td style="text-align: center;">-</td>
<td style="text-align: left;">初始情况</td>
</tr>
<tr>
<td style="text-align: center;">8</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">13</td>
<td style="text-align: left;"><span class="arithmatex">\(T_1\)</span> 的前 13 个与 <span class="arithmatex">\(T_2\)</span> 归并，结果写入 <span class="arithmatex">\(T_3\)</span></td>
</tr>
<tr>
<td style="text-align: center;">-</td>
<td style="text-align: center;">8</td>
<td style="text-align: center;">5</td>
<td style="text-align: left;"><span class="arithmatex">\(T_3\)</span> 的前 8 个与 <span class="arithmatex">\(T_1\)</span> 归并，结果写入 <span class="arithmatex">\(T_2\)</span></td>
</tr>
<tr>
<td style="text-align: center;">5</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">-</td>
<td style="text-align: left;">略</td>
</tr>
<tr>
<td style="text-align: center;">2</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">3</td>
<td style="text-align: left;">略</td>
</tr>
<tr>
<td style="text-align: center;">-</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">1</td>
<td style="text-align: left;">略</td>
</tr>
<tr>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">-</td>
<td style="text-align: left;">略</td>
</tr>
<tr>
<td style="text-align: center;">0</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">1</td>
<td style="text-align: left;">略</td>
</tr>
</tbody>
</table>
</div>
<p>使用 Fibonacci 我们总可以滚动着将 <span class="arithmatex">\(\#run\)</span> 的规模缩小。</p>
<details class="extra" open="open">
<summary>k-way merge with k-order Fibonacci Sequence</summary>
<p>对于 <span class="arithmatex">\(k\)</span>-way merge，我们只需要构造 k 阶 Fibonacci 数列，然后按照这个数列来分配每个 tape 的 <span class="arithmatex">\(\#run\)</span> 即可。</p>
<div class="admonition definition">
<p class="admonition-title">k-order Fibonacci Sequence</p>
<p>给出 k 阶 Fibonacci 数列（与 PPT 略有不同，主要体现在下标从谁开始，无伤大雅）：</p>
<div class="arithmatex">\[
\left\{
\begin{aligned}
    F^k_1 &amp;= 1 \\
    F^k_2 &amp;= 1 \\
    &amp; \vdots\\
    F^k_n &amp;= F^k_{n-1} + F^k_{n-2} + \cdots + F^k_{n-k} \quad (n &gt; k)
\end{aligned}
\right.
\]</div>
</div>
<p>这个结论看起来很自然，但是实际上是怎么操作的呢？PPT 压根没讲，因此，我在询问 ch 老师以后，写下了这个部分，旨在补充 <span class="arithmatex">\(k\)</span>-way merge 使用 k 阶 Fibonacci 优化的方法。</p>
<blockquote>
<p>首先，做一些强调：</p>
<ol>
<li>该方法陈述过程中，k 路始终直接合并成一路（千万不要用“iterative”的思路来考虑，就算 iterative，迭代完了也还是 k 路归为 1 路）；</li>
<li>我们的目的是优化每一个 pass 中每个 tape 的 <span class="arithmatex">\(\#run\)</span> 不一样带来的性能问题（例如尴尬的 <span class="arithmatex">\(n\)</span> 和 <span class="arithmatex">\(n+1\)</span> 归，下一个 pass 就得 <span class="arithmatex">\(1\)</span> 和  <span class="arithmatex">\(n\)</span> 归了）；</li>
</ol>
</blockquote>
<p>对于第 <span class="arithmatex">\(i\)</span> 个 pass，有 <span class="arithmatex">\(k\)</span> 个 tape，我们记每一个 tape 的 <span class="arithmatex">\(\#run\)</span> 为 <span class="arithmatex">\(r_i\)</span>，则有：</p>
<ul>
<li><span class="arithmatex">\(\max\{r_i\} = F^k_j\)</span>;</li>
<li><span class="arithmatex">\(\min\{r_i\} = F^k_{j-1}\)</span>;</li>
</ul>
<p>也就是说，每个 pass 最大和最小的 <span class="arithmatex">\(\#run\)</span> 分别有 k 阶 Fibonacci 中相邻的两项。</p>
<blockquote>
<p>这里分开用 i 和 j 是想表达这个匹配关系不重要，重要的是最大值最小值由 Fibonacci 相邻项所确定。</p>
</blockquote>
<p>那么夹在最大和最小的中间的其他 <span class="arithmatex">\(\#run\)</span> 要如何确定呢？首先我们进行一段推导：</p>
<p>假设 <span class="arithmatex">\(\{r_i\}\)</span> 经过排序，并且刚好能凑上我们所需要的数量，有：</p>
<div class="arithmatex">\[
r_k &gt; r_{k-1} &gt; ... &gt; r_{2} &gt; r_{1}
\text{where } r_k = F^k_j \text{ and } r_1 = F^k_{j-1}
\]</div>
<p>在这一个 pass 中，我们将所有 tape 的前 <span class="arithmatex">\(r1\)</span> 个 run 拿出来 merge，这样，除了 <span class="arithmatex">\(r_1\)</span> 这个 tape，其他 tape 的 <span class="arithmatex">\(\#run\)</span> 都变为 <span class="arithmatex">\(r_i-r_1\)</span>。此时有不等关系：</p>
<div class="arithmatex">\[
r_1 &gt; r_k - r_1 &gt; r_{k-1} - r_1 &gt; ... &gt; r_{2} - r_1
\]</div>
<p>这里唯一需要说明的就是 <span class="arithmatex">\(r_1 &gt; r_k - r_1\)</span>：</p>
<details class="proof">
<summary>proof of the relation</summary>
<div class="arithmatex">\[
\begin{aligned}
    &amp;\begin{aligned}
        \because r_1 
        &amp;= F^k_{j-1} \\
        &amp;= F^k_{j-2} + \cdots + F^k_{j-k} + F^k_{j-k-1}
    \end{aligned}  &amp; (1)\\
    &amp;\begin{aligned}
        \text{and } r_k
        &amp;= F^k_{j} \\
        &amp;= F^k_{j-1} + F^k_{j-2} + \cdots + F^k_{j-k}
    \end{aligned}  &amp; (2)\\
    &amp;\begin{aligned}
        \therefore r_k - r_1 
        &amp;= F^k_{j} - F^k_{j-1} \quad \text{ i.e. } (2) - (1)\\
        &amp;= F^k_{j-2} + \cdots + F^k_{j-k}
    \end{aligned}  &amp; (3)\\
    &amp;\begin{aligned}
        \therefore r_1 - (r_k - r_1)
        &amp;= F^k_{j-k-1} &gt; 0 \quad \text{ i.e. } (1) - (3) \\
    \end{aligned} \\
    &amp;\begin{aligned}
    \therefore r_1 &gt; r_k - r_1
    \end{aligned} \\  
\end{aligned}
\]</div>
</details>
<p>如果我们将现在这个排序后的数列记为 <span class="arithmatex">\(\{r_i'\}\)</span>，则有：</p>
<div class="arithmatex">\[
\left\{
\begin{aligned}
    r_1' &amp;= r_2 - r_1 \\
    r_2' &amp;= r_3 - r_1 \\
    \vdots \\
    r_{k-1}' &amp;= r_k - r_1 \\
    r_k' &amp;= r_1
\end{aligned}
\right.
\]</div>
<p>此时根据我们关于最大最小值的陈述，又有：</p>
<div class="arithmatex">\[
\left\{
\begin{aligned}
    r_1' &amp;= F^k_{j-2} \\
    r_k' &amp;= F^k_{j-1}
\end{aligned}
\right.
\]</div>
<p>于是可以推得：<span class="arithmatex">\(r_2 = r_1 + F^k_{j-2} = F^k_{j-1} + F^k_{j-2}\)</span>。关于 <span class="arithmatex">\(r_3, r_4\)</span>，也是一样的办法，将 <span class="arithmatex">\(r_2\)</span> 的结论迁移到 <span class="arithmatex">\(r_2'\)</span>，再回过头得到 <span class="arithmatex">\(r_3 = r_1 + r_2'= F^k_{j-1} + F^k_{j-2} + F^k_{j-3}\)</span>，以此类推，可以得到最终结论：</p>
<div class="arithmatex">\[
\left\{
\begin{aligned}
    r_1 &amp;= F^k_{j-1} \\
    r_2 &amp;= F^k_{j-1} + F^k_{j-2} \\
    r_3 &amp;= F^k_{j-1} + F^k_{j-2} + F^k_{j-3} \\
    \vdots \\
    r_k &amp;= F^k_{j-1} + F^k_{j-2} + ... + F^k_{j-k} = F^k_{j}
\end{aligned}
\right.
\]</div>
</details>
<div class="admonition question">
<p class="admonition-title">思考题</p>
<p>可以感受思考一下这个特性（考虑 2-way 即可）与黄金比例的关系！</p>
<p>hint: 如何理解 <span class="arithmatex">\(\frac{a_n}{a_{n-1}} \approx \frac{a_{n-1}}{a_n - a_{n-1}}\)</span> 与这个性质的关系？</p>
</div>
<p>当然，刚好能凑上 Fibonacci 的情况自然是少数，对于无法凑上 Fibonacci 的情况，我们可以将多余的部分均匀的分到较多若干 tape 上，以相对的利用 Fibonacci 数列的性质（联系思考题理解）。</p>
<div class="admonition warning">
<p class="admonition-title">注意</p>
<p>或许你已经开始产生疑问了，如果这样来做，前面对 <span class="arithmatex">\(\#pass\)</span> 的分析是不是不成立了呢？</p>
<p>我想应该确实不再完全一样了，但是并不影响我们之后利用那个结论做定性分析，我们只需要知道，采取 Fibonacci 策略来优化会导致 <span class="arithmatex">\(\#pass\)</span> 增多即可。</p>
</div>
<hr>
<h3 id="k">k 路内排序优化<a class="headerlink" href="#k" title="Permanent link">¶</a></h3>
<p>随着 <span class="arithmatex">\(k\)</span> 的增加，我们不能再像两路归并那样直接输出较小的那个，而是需要维护数据结构来总是输出 k 个中最小的那个——我们用堆来维护每一个 run 在内存中的数据的队首元素（同时也是最小元素），每当堆顶元素被输出，就需要从对应的 run 中读入下一个元素。</p>
<div class="admonition warning">
<p class="admonition-title">注意</p>
<p>需要注意，这里的堆是额外维护的，而每次推入堆中的元素都是从对应的 run 的 buffer 中拿的，而不是每次都从硬盘中拿。</p>
</div>
<hr>
<h4 id="_8">霍夫曼树优化<a class="headerlink" href="#_8" title="Permanent link">¶</a></h4>
<p>当然，我们也可以不使用直接 <span class="arithmatex">\(k\)</span> 路合并，而是采用两两归并的方法，也就是 wiki 中提到的<a href="https://en.wikipedia.org/wiki/K-way_merge_algorithm#Iterative_2-way_merge">迭代归并</a>（注意，该条目中提到的归并并没有说明是外排序背景，但是可以迁移）。 </p>
<p>假设我们现在有若干个 run，并且我们将要进行两两归并，那么我们可以根据每一个 run 的大小，根据霍夫曼树的规律来进行归并，即总是选最小的两个进行归并。</p>
<hr>
<h3 id="_9">并行优化<a class="headerlink" href="#_9" title="Permanent link">¶</a></h3>
<p>这里并行的目标主要是使算法支持数据的读-用-写的流水线，也就是说我们要想办法让读不阻塞用，用不阻塞写。</p>
<p>先前我们需要先读入数据，<strong>然后</strong>进行排序，排序<strong>完了</strong>再写入磁盘，腾出内存空间以供下一次读入。那为什么会阻塞呢？因为我们没法读一个正在写的数据块，所以我们只需要在不同的数据块读和写就行了。对于 <span class="arithmatex">\(k\)</span>-way 中的每一路，我们都提供两个 input buffer，一个用于写，一个用于排序。当排序 buffer 空了的时候，就和读满了的 input buffer 交换，无缝衔接继续输出。于此同时，刚刚被交换过去的 buffer 则可用于继续读入。</p>
<p>因此，如果我们执行 direct <span class="arithmatex">\(k\)</span>-way merge，就需要 <span class="arithmatex">\(2k\)</span> 个 input buffer（这里强调 direct 是因为，如果使用 iterative 的话，input buffer 只需要 4 个）。</p>
<p>而对于输出，我们只需要 2 个 output buffer 交替使用即可，一个用来接收来自排序算法的输出，一个用来将数据写入磁盘。</p>
<p>但是，并行优化的缺点就是占据了更多的内存空间——原先 <span class="arithmatex">\(k + 1\)</span> 个 buffer 平分的用于处理数据的内存，现在需要被 <span class="arithmatex">\(2k + 2\)</span> 个 buffer 平分，所以每一个 buffer 的大小会变小。进而导致每一次从 disk 中读取的数据变少，所以要读完数据所需要的读取次数就增加，即 seek 次数增加。</p>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="最后更新">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"></path></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime" title="2025年9月17日 09:25:47 CST">2025年9月17日 09:25:47</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="创建日期">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"></path></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-datetime" title="2025年9月17日 09:25:47 CST">2025年9月17日 09:25:47</span>
  </span>

    
    
    
  </aside>






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"></path></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright © 2025 voilern
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/voilern" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"></path></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://space.bilibili.com/403057961" target="_blank" rel="noopener" title="space.bilibili.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M488.6 104.1c16.7 18.1 24.4 39.7 23.3 65.7v202.4c-.4 26.4-9.2 48.1-26.5 65.1-17.2 17-39.1 25.9-65.5 26.7H92.02c-26.45-.8-48.21-9.8-65.28-27.2C9.682 419.4.767 396.5 0 368.2V169.8c.767-26 9.682-47.6 26.74-65.7C43.81 87.75 65.57 78.77 92.02 78h29.38L96.05 52.19c-5.75-5.73-8.63-13-8.63-21.79 0-8.8 2.88-16.06 8.63-21.797C101.8 2.868 109.1 0 117.9 0q13.2 0 21.9 8.603L213.1 78h88l74.5-69.397C381.7 2.868 389.2 0 398 0q13.2 0 21.9 8.603c5.7 5.737 8.6 12.997 8.6 21.797 0 8.79-2.9 16.06-8.6 21.79L394.6 78h29.3c26.4.77 48 9.75 64.7 26.1m-38.8 69.7c-.4-9.6-3.7-17.4-10.7-23.5-5.2-6.1-14-9.4-22.7-9.8H96.05c-9.59.4-17.45 3.7-23.58 9.8-6.14 6.1-9.4 13.9-9.78 23.5v194.4c0 9.2 3.26 17 9.78 23.5s14.38 9.8 23.58 9.8H416.4c9.2 0 17-3.3 23.3-9.8s9.7-14.3 10.1-23.5zm-264.3 42.7c6.3 6.3 9.7 14.1 10.1 23.2V273c-.4 9.2-3.7 16.9-9.8 23.2-6.2 6.3-14 9.5-23.6 9.5s-17.5-3.2-23.6-9.5-9.4-14-9.8-23.2v-33.3c.4-9.1 3.8-16.9 10.1-23.2s13.2-9.6 23.3-10c9.2.4 17 3.7 23.3 10m191.5 0c6.3 6.3 9.7 14.1 10.1 23.2V273c-.4 9.2-3.7 16.9-9.8 23.2s-14 9.5-23.6 9.5-17.4-3.2-23.6-9.5c-7-6.3-9.4-14-9.7-23.2v-33.3c.3-9.1 3.7-16.9 10-23.2s14.1-9.6 23.3-10c9.2.4 17 3.7 23.3 10"></path></svg>
    </a>
  
    
    
    
    
    <a href="mailto:<hejiayi@zju.edu.cn>" target="_blank" rel="noopener" title="" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4l217.6 163.2c11.4 8.5 27 8.5 38.4 0l217.6-163.2c12.1-9.1 19.2-23.3 19.2-38.4 0-26.5-21.5-48-48-48zM0 176v208c0 35.3 28.7 64 64 64h384c35.3 0 64-28.7 64-64V176L294.4 339.2a63.9 63.9 0 0 1-76.8 0z"></path></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.indexes", "navigation.tracking", "navigation.tabs", "navigation.top", "content.code.copy", "content.code.select", "search.suggest", "search.highlight"], "search": "../../../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.c8b220af.min.js"></script>
      
        <script src="../../../javascripts/katex.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/katex.min.js"></script>
      
        <script src="https://unpkg.com/katex@0/dist/contrib/auto-render.min.js"></script>
      
    
  
<script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(()=>{ lightbox.reload(); });
</script></body></html>